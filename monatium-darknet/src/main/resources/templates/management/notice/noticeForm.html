<!DOCTYPE html>
<!-- v3 -->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>공지사항 작성</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
  <style>
    .ql-container {
        min-height: 200px; /* 에디터 최소 높이 */
    }
  </style>
</head>
<body>
<div class="container mt-4">
  <h1>공지사항 작성</h1>
  <form action="/notices/create" method="post" enctype="multipart/form-data">
    <div class="mb-3">
      <label for="title" class="form-label">제목</label>
      <input type="text" id="title" name="title" class="form-control" required>
    </div>
    <div class="mb-3">
      <label for="category" class="form-label">카테고리</label>
      <select id="category" name="category" class="form-select" required>
        <option value="notice">공지사항</option>
        <option value="event">이벤트</option>
        <option value="update">업데이트</option>
        <option value="devnote">개발자 노트</option>
      </select>
    </div>
    <div class="mb-3">
      <label for="editor" class="form-label">내용</label>
      <div id="editor"></div>
      <textarea id="content" name="content" class="d-none"></textarea>
      <input type="hidden" id="imageUrls" name="imageUrls" />
    </div>
    <button type="submit" class="btn btn-primary">등록</button>
    <a href="/notices" class="btn btn-secondary">취소</a>
  </form>
</div>

<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

<script>
  // 이미지 URL 리스트를 저장할 배열
  let imageUrls = [];

  // Quill 초기화
  var quill = new Quill('#editor', {
      theme: 'snow',
      placeholder: '공지사항 내용을 입력하세요...',
      modules: {
          toolbar: {
              container: [
                  [{ 'header': [1, 2, false] }],
                  ['bold', 'italic', 'underline'],
                  ['link', 'image'],
                  [{ 'list': 'ordered' }, { 'list': 'bullet' }]
              ],
              handlers: {
                  image: function () {
                      var input = document.createElement('input');
                      input.type = 'file';
                      input.accept = 'image/*';
                      input.onchange = async function () {
                          var file = input.files[0];
                          var formData = new FormData();
                          formData.append('file', file);

                          // 서버로 이미지 업로드
                          const response = await fetch('/api/images/upload', {
                              method: 'POST',
                              body: formData
                          });
                          const result = await response.json();

                          if (result.success) {
                              // URL 리스트에 추가
                              imageUrls.push(result.imageUrl);

                              // 에디터에 이미지 삽입
                              var range = quill.getSelection();
                              quill.insertEmbed(range.index, 'image', result.imageUrl);

                              // 숨겨진 필드에 리스트 업데이트
                              document.querySelector('#imageUrls').value = JSON.stringify(imageUrls);
                          } else {
                              alert('이미지 업로드 실패');
                          }
                      };
                      input.click();
                  }
              }
          }
      }
  });

  // 이미지 삭제 처리
  quill.on('text-change', function (delta, oldDelta, source) {
      if (source === 'user') {
          // 에디터에 남아있는 이미지 URL 수집
          const currentImages = Array.from(document.querySelectorAll('#editor img')).map(img => img.src);

          // imageUrls 배열에서 제거된 URL 삭제
          imageUrls = imageUrls.filter(url => currentImages.includes(url));

          // 숨겨진 필드에 리스트 업데이트
          document.querySelector('#imageUrls').value = JSON.stringify(imageUrls);
      }
  });

  // 폼 제출 시 HTML 본문과 이미지 URL 리스트 전송
  document.querySelector('form').addEventListener('submit', function (event) {
      // Quill의 HTML 본문 저장
      document.querySelector('#content').value = quill.root.innerHTML;

      // 이미지 URL 리스트를 JSON 문자열로 변환해 숨겨진 필드에 저장
      document.querySelector('#imageUrls').value = JSON.stringify(imageUrls);
  });

</script>
</body>
</html>
